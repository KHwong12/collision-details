---
title: "Details of Traffic Collision - Test Layout"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    number_sections: no
    css: styles/styles.css
    theme: lumen
    toc: no
    toc_float: no
    self_contained: false
    lib_dir: libs
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

options(scipen = 999)
```

```{r, eval=FALSE}
# Temp solution before next release to CRAN
devtools::install_github("Hong-Kong-Districts-Info/hkdatasets", ref = "feature/updated-collision-data")
```



```{r}
library(dplyr)
library(hkdatasets)

library(leaflet)
library(kableExtra)

library(htmltools)
```

```{r}
## Take data from {hkdatasets}
hk_accidents = hkdatasets::hk_accidents
hk_vehicles = hkdatasets::hk_vehicles
hk_casualties = hkdatasets::hk_casualties
```

```{r}
# Selected for test
SELECTED_ACCIDENT_NO = 66897

hk_accidents_selected = filter(hk_accidents, Serial_No_ == SELECTED_ACCIDENT_NO)

```


## Detail Report of Accident No. `r SELECTED_ACCIDENT_NO`

<br>

```{r}
# Fill color palette according to the severity of the accident
fill_palette <- colorFactor(palette = c("#230B4C", "#C03A51", "#F1701E"), domain = c("Fatal", "Serious", "Slight"))

htmltools::HTML(
  paste(
    # Square symbol indicating severity level
    '<div style="height:20px; width:20px; float:left; margin-right:10px; background-color:', fill_palette(hk_accidents_selected[["Severity"]]), '";> </div>',
    
    # Collision severity
    '<h3 style="display: inline !important">', hk_accidents_selected[["Severity"]], ' Collision', '</h3>'
  )
)
```


This accident happened on `r strftime(hk_accidents_selected[["Date_Time"]], "%d %B, %Y (%A), at %H:%S")`. It was a `r hk_accidents_selected[["Severity"]]` accident with `r hk_accidents_selected[["No_of_Casualties_Injured"]]` causalities, involving `r hk_accidents_selected[["No_of_Vehicles_Involved"]]` vehicles. The weather was `r hk_accidents_selected[["Weather"]]` and `r hk_accidents_selected[["Rain"]]`.

The road where accident happened is a `r hk_accidents_selected[["Road_Type"]]` road.

The full details of this accident are shown below.

```{r}
t(hk_accidents_selected) %>% 
  knitr::kable(caption = "Details of accident", digits = 3, format.args = list(big.mark = ",")) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>%
  kableExtra::column_spec(1, bold = T, border_right = T)
```


Location of the accident is shown below.

```{r, eval=TRUE}
is_valid_loglat = !is.na(hk_accidents_selected$latitude) & !is.na(hk_accidents_selected$longitude)

# TODO: print additional message if collision does not have long/lat data
```

```{r, eval=is_valid_loglat, out.width='100%'}

leaflet(hk_accidents_selected) %>%
  addProviderTiles("Stamen.TonerLite") %>%
  addMarkers(~longitude, ~latitude)
```


---

## Vehicles involved

```{r}
hk_vehicles_selected = filter(hk_vehicles, Serial_No_ == SELECTED_ACCIDENT_NO)
```

```{r}
hk_vehicles_selected  %>% 
  knitr::kable(caption = "List of vehicles involved", digits = 3, format.args = list(big.mark = ",")) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

## Causalities

```{r}
hk_casualties_selected = filter(hk_casualties, Serial_No_ == SELECTED_ACCIDENT_NO)
```

```{r}
hk_casualties_selected %>% 
  select(-c(Serial_No_, Year, starts_with("Location_of_Injury_"))) %>%
  knitr::kable(caption = "List of casualties", digits = 3, format.args = list(big.mark = ",")) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```
